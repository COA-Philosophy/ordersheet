// =============================================================================
// 改良版CSV保存機能（顧客マスター・商品明細シート対応）
// =============================================================================

// データ管理用CSV保存（顧客マスター用と商品明細用の2ファイル出力）
function saveToCSV() {
    try {
        const formData = collectFormData();
        const now = new Date();
        const dateStr = now.getFullYear() + 
                       String(now.getMonth() + 1).padStart(2, '0') + 
                       String(now.getDate()).padStart(2, '0');
        
        // 顧客名を取得
        const customerName = (formData.lastName + formData.firstName) || 'お客様';
        
        // 1. 顧客マスター用CSV作成
        saveCustomerMasterCSV(formData, customerName, dateStr);
        
        // 2. 商品明細用CSV作成（アイテムごとに行を分割）
        saveProductDetailCSV(formData, customerName, dateStr);
        
        showStatusMessage('✅ 顧客マスター用と商品明細用の2つのCSVファイルを保存しました', 'success');
        
    } catch (error) {
        console.error('CSV保存エラー:', error);
        showStatusMessage('❌ CSV保存に失敗しました', 'error');
    }
}

// 顧客マスター用CSV
function saveCustomerMasterCSV(formData, customerName, dateStr) {
    // 顧客マスターシートの列順
    const headers = [
        '顧客ID', '注文番号', '注文日', '姓', '名', 'フリガナ（姓）', 'フリガナ（名）', 
        '生年月日', '性別', '職業', '郵便番号', '都道府県', '住所', '電話番号', 
        'メールアドレス', 'LINE ID', '紹介者', '身長', '体重', '胸囲', 'ウエスト', 
        'ヒップ', '肩幅', '上着丈', '首回り', '袖丈左', '袖丈右', '裄丈', 'AH', 
        '二の腕周り', '肘周り', '手首周り', 'ベスト丈', 'パンツウエスト', '股上', 
        '股下', '太もも周り', '膝周り', 'ふくらはぎ周り', '肩傾斜左', '肩傾斜右', 
        '鎌深', 'ストラップ寸', 'オーバーショルダー寸', '体型の特徴・注意点', 
        'アイテム数', '総額', '支払方法', '内金', '残金', '受注日', '中縫い日', 
        '仕上がり予定日', '全般備考', '初回登録日', '最終更新日', 'ステータス'
    ];
    
    // 性別の変換
    const genderText = formData.gender === 'male' ? '男性' : 
                      formData.gender === 'female' ? '女性' : 
                      formData.gender === 'other' ? 'その他' : formData.gender;
    
    // 支払方法の変換
    const paymentText = formData.payment.method === 'cash' ? '現金' : 
                       formData.payment.method === 'card' ? 'クレジットカード' : 
                       formData.payment.method === 'transfer' ? '銀行振込' : 
                       formData.payment.method === 'installment' ? '分割払い' : formData.payment.method;
    
    // データ値（顧客マスターの列順に対応）
    const values = [
        '', // 顧客ID（後で手動採番）
        formData.orderNumber,
        formData.orderDate,
        formData.lastName,
        formData.firstName,
        formData.lastNameKana,
        formData.firstNameKana,
        formData.birthDate,
        genderText,
        formData.occupation,
        formData.postalCode,
        formData.prefecture,
        formData.address,
        formData.phone,
        formData.email,
        formData.lineId,
        formData.referrer,
        formData.measurements.height,
        formData.measurements.weight,
        formData.measurements.chest,
        formData.measurements.waist,
        formData.measurements.hip,
        formData.measurements.shoulderWidth,
        formData.measurements.jacketLength,
        formData.measurements.neckSize,
        formData.measurements.armLengthLeft,
        formData.measurements.armLengthRight,
        formData.measurements.yokoLength,
        formData.measurements.armHole,
        formData.measurements.upperArmCircum,
        formData.measurements.elbowCircum,
        formData.measurements.wristCircum,
        formData.measurements.vestLength,
        formData.measurements.pantWaist,
        formData.measurements.crotchDepth,
        formData.measurements.inseam,
        formData.measurements.thighCircum,
        formData.measurements.kneeCircum,
        formData.measurements.calfCircum,
        formData.measurements.shoulderSlopeLeft || '',
        formData.measurements.shoulderSlopeRight || '',
        formData.measurements.kamaDepth || '',
        formData.measurements.strapLength || '',
        formData.measurements.overShoulderLength || '',
        formData.measurements.bodyType,
        formData.items.length, // アイテム数
        formData.totalPrice,
        paymentText,
        formData.payment.deposit,
        formData.payment.balance,
        formData.payment.orderDate,
        formData.payment.fittingDate,
        formData.payment.completionDate,
        formData.generalNotes,
        new Date().toLocaleDateString('ja-JP'), // 初回登録日
        new Date().toLocaleDateString('ja-JP'), // 最終更新日
        '新規' // ステータス
    ];
    
    // CSV作成
    const csvContent = [
        headers.join(','),
        values.map(v => {
            const str = String(v || '');
            // カンマ、改行、ダブルクォートを含む場合はダブルクォートで囲む
            if (str.includes(',') || str.includes('\n') || str.includes('"')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }).join(',')
    ].join('\n');
    
    // BOM付きでダウンロード
    const bom = '\uFEFF';
    const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8' });
    const filename = `顧客マスター_${customerName}_${dateStr}.csv`;
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
}

// 商品明細用CSV（アイテムごとに行を分割）
function saveProductDetailCSV(formData, customerName, dateStr) {
    // 商品明細シートの列順
    const headers = [
        '注文番号', '着用者名', 'アイテム種別', '生地名', '生地番号', '色', 
        'ジャケットスタイル', '裏地', 'ボタン', '衿型', 'カフス', 'オプション', 
        '工賃', '仕入日', '納期', '備考'
    ];
    
    // データ行を作成（アイテムごと）
    const dataRows = [];
    
    formData.items.forEach((item, index) => {
        // オプションを文字列に変換
        const optionsText = item.options.join('、');
        
        // ジャケットスタイルの変換
        const jacketStyleText = item.jacketStyle === 'single' ? 'シングル' : 
                               item.jacketStyle === 'double' ? 'ダブル' : item.jacketStyle;
        
        // 衿型の日本語変換
        const lapelStyleText = convertLapelStyle(item.lapelStyle);
        
        // カフスの日本語変換
        const cuffStyleText = convertCuffStyle(item.cuffStyle);
        
        const row = [
            formData.orderNumber,
            customerName,
            item.itemType || '',
            item.fabric || '', // 生地名
            '', // 生地番号（オーダーシートにない場合は空欄）
            item.color || '',
            jacketStyleText || '',
            item.lining || '',
            item.buttons || '',
            lapelStyleText || '',
            cuffStyleText || '',
            optionsText || '',
            item.price || '',
            formData.orderDate, // 仕入日として注文日を使用
            item.deliveryDate || '',
            item.notes || ''
        ];
        
        dataRows.push(row);
    });
    
    // CSV作成
    const csvContent = [
        headers.join(','),
        ...dataRows.map(row => 
            row.map(cell => {
                const str = String(cell || '');
                if (str.includes(',') || str.includes('\n') || str.includes('"')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            }).join(',')
        )
    ].join('\n');
    
    // BOM付きでダウンロード
    const bom = '\uFEFF';
    const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8' });
    const filename = `商品明細_${customerName}_${dateStr}.csv`;
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
}

// 衿型の変換関数
function convertLapelStyle(lapelStyle) {
    const lapelMap = {
        'notched': 'ノッチドラペル',
        'peaked': 'ピークドラペル',
        'shawl': 'ショールカラー',
        'narrow': 'ナローラペル',
        'wide': 'ワイドラペル',
        'regular_collar': 'レギュラーカラー',
        'semi_wide_collar': 'セミワイドカラー',
        'wide_collar': 'ワイドカラー',
        'horizontal_wide_collar': 'ホリゾンタルワイドカラー',
        'round_collar': 'ラウンドカラー',
        'open_collar': 'オープンカラー',
        'stand_collar': 'スタンドカラー',
        'wing_collar': 'ウィングカラー',
        'short_regular_collar': 'ショートレギュラーカラー',
        'short_semi_wide_collar': 'ショートセミワイドカラー',
        'short_wide_collar': 'ショートワイドカラー',
        'short_horizontal_wide_collar': 'ショートホリゾンタルワイドカラー',
        'short_round_collar': 'ショートラウンドカラー'
    };
    return lapelMap[lapelStyle] || lapelStyle;
}

// カフスの変換関数
function convertCuffStyle(cuffStyle) {
    const cuffMap = {
        '4button': '4つボタン本切羽',
        '3button': '3つボタン本切羽',
        '4button_fake': '4つボタン（飾り）',
        '3button_fake': '3つボタン（飾り）',
        'surgeons': 'サージャンカフス',
        'kissing': 'キッシングボタン',
        'regular_no_opening': 'レギュラー（開きなし）',
        'small_round': '小丸',
        'round_b': 'ラウンドB',
        'round_c': 'ラウンドC',
        'cut_corner': '角落ち',
        'corn': 'コーン',
        'turn_up': 'ターンナップ',
        'double_cuff': 'ダブル',
        'arrow': 'アロー'
    };
    return cuffMap[cuffStyle] || cuffStyle;
}

// Excel形式で保存（統合版）
function saveToExcel() {
    try {
        const formData = collectFormData();
        const now = new Date();
        const dateStr = now.getFullYear() + 
                       String(now.getMonth() + 1).padStart(2, '0') + 
                       String(now.getDate()).padStart(2, '0');
        
        const customerName = (formData.lastName + formData.firstName) || 'お客様';
        
        // 見やすい形式でデータを整形
        const rows = [];
        
        // タイトル
        rows.push(['オーダーシート']);
        rows.push([]);
        rows.push(['作成日時', new Date().toLocaleString('ja-JP')]);
        rows.push(['注文番号', formData.orderNumber]);
        rows.push([]);
        
        // お客様情報
        rows.push(['【お客様情報】']);
        rows.push(['お名前', customerName]);
        rows.push(['フリガナ', (formData.lastNameKana || '') + ' ' + (formData.firstNameKana || '')]);
        rows.push(['生年月日', formData.birthDate || '']);
        rows.push(['電話番号', formData.phone || '']);
        rows.push(['メールアドレス', formData.email || '']);
        rows.push(['郵便番号', formData.postalCode || '']);
        rows.push(['住所', (formData.prefecture || '') + (formData.address || '')]);
        rows.push([]);
        
        // 主要採寸
        rows.push(['【採寸情報】']);
        if (formData.measurements.height) rows.push(['身長', formData.measurements.height + 'cm']);
        if (formData.measurements.weight) rows.push(['体重', formData.measurements.weight + 'kg']);
        if (formData.measurements.chest) rows.push(['胸囲', formData.measurements.chest + 'cm']);
        if (formData.measurements.waist) rows.push(['ウエスト', formData.measurements.waist + 'cm']);
        if (formData.measurements.shoulderWidth) rows.push(['肩幅', formData.measurements.shoulderWidth + 'cm']);
        rows.push([]);
        
        // オーダー内容
        rows.push(['【オーダー内容】']);
        formData.items.forEach((item, index) => {
            rows.push([`アイテム${index + 1}`, item.itemType || '']);
            if (item.fabric) rows.push(['生地', item.fabric]);
            if (item.color) rows.push(['色', item.color]);
            if (item.price) rows.push(['価格', '¥' + (item.price || 0).toLocaleString()]);
            if (item.deliveryDate) rows.push(['納期', item.deliveryDate]);
            rows.push([]);
        });
        
        // 支払い情報
        rows.push(['【お支払い情報】']);
        rows.push(['総計', '¥' + formData.totalPrice.toLocaleString()]);
        rows.push(['お支払い方法', formData.payment.method || '']);
        if (formData.payment.deposit) rows.push(['内金', '¥' + formData.payment.deposit.toLocaleString()]);
        if (formData.payment.balance) rows.push(['残金', '¥' + formData.payment.balance.toLocaleString()]);
        
        // CSV変換
        const csvContent = rows.map(row => 
            row.map(cell => {
                const str = String(cell || '');
                if (str.includes(',') || str.includes('\n') || str.includes('"')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            }).join(',')
        ).join('\n');
        
        // BOM付きでダウンロード
        const bom = '\uFEFF';
        const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8' });
        const filename = `オーダーシート_${customerName}_${dateStr}.csv`;
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
        
        showStatusMessage(`✅ Excelファイルとして保存しました: ${filename}`, 'success');
        
    } catch (error) {
        console.error('Excel保存エラー:', error);
        showStatusMessage('❌ Excel保存に失敗しました', 'error');
    }
}